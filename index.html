<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>循環アイディア発掘ナビ</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            light: '#0179E8',
                            DEFAULT: '#225AD3',
                            dark: '#1a45a3',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base & Noise Texture */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            position: relative;
            overflow-x: hidden;
        }
        
        .dark body {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .bg-noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: -1;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .bg-gradient-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -2;
            opacity: 0.4;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* Custom Input Styling */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: #e2e8f0;
            border-radius: 5px;
            background-image: linear-gradient(#225AD3, #225AD3);
            background-repeat: no-repeat;
        }
        .dark input[type="range"] {
            background: #334155;
            background-image: linear-gradient(#0179E8, #0179E8);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 4px 0 rgba(0,0,0, 0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* Checkbox/Radio Hidden Logic */
        .input-hidden {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        
        .selection-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-hidden:checked + .selection-card {
            background: linear-gradient(135deg, rgba(34, 90, 211, 0.1), rgba(1, 121, 232, 0.05));
            border-color: #225AD3;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(34, 90, 211, 0.15);
        }
        .dark .input-hidden:checked + .selection-card {
            background: linear-gradient(135deg, rgba(34, 90, 211, 0.3), rgba(1, 121, 232, 0.1));
            border-color: #0179E8;
        }

        /* Menu Dropdown */
        .menu-dropdown {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .menu-dropdown.active {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }

        /* Print Layout */
        @media print {
            body { background: white; color: black; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .glass, .glass-card { background: none; border: 1px solid #ccc; box-shadow: none; backdrop-filter: none; }
            #result-section { display: block !important; padding: 0; margin: 0; }
            .page-break { page-break-before: always; }
        }
        
        /* Animations */
        .step-transition {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .hidden-step {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        .active-step {
            opacity: 1;
            transform: translateX(0);
            position: relative;
        }
    </style>
</head>
<body class="min-h-screen text-slate-800 dark:text-slate-100 transition-colors duration-300">

    <!-- Background Effects -->
    <div class="bg-noise"></div>
    <div class="bg-gradient-orb top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-400/20 dark:bg-blue-600/10"></div>
    <div class="bg-gradient-orb bottom-[-10%] right-[-10%] w-[400px] h-[400px] bg-cyan-400/20 dark:bg-cyan-600/10"></div>

    <!-- Header -->
    <header class="fixed top-0 left-0 w-full z-40 glass transition-all duration-300 no-print">
        <div class="max-w-md mx-auto px-6 py-4 flex justify-between items-center relative">
            <div class="flex items-center gap-2 cursor-pointer" onclick="goToHero()">
                <i class="fa-solid fa-arrows-spin text-brand dark:text-brand-light text-xl"></i>
                <span class="font-bold text-lg tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-brand to-brand-light">IdeaNavi</span>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Guide Button -->
                <button onclick="showGuideModal()" class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <i class="fa-solid fa-circle-question"></i>
                </button>
                
                <!-- Settings Button -->
                <button id="settingsBtn" onclick="toggleMenu()" class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors relative z-50">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>

            <!-- Settings Dropdown -->
            <div id="settingsMenu" class="menu-dropdown absolute top-16 right-4 w-60 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden z-50">
                <div class="p-2 space-y-1">
                    <button id="themeToggle" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-between group transition-colors">
                        <span class="text-sm font-medium"><i class="fa-solid fa-circle-half-stroke mr-3 text-slate-400"></i>テーマ切替</span>
                        <span class="text-xs bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded group-hover:bg-white dark:group-hover:bg-slate-600">Auto</span>
                    </button>
                    <button onclick="fillDemoData()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-between group transition-colors">
                        <span class="text-sm font-medium"><i class="fa-solid fa-wand-magic-sparkles mr-3 text-brand"></i>デモ入力</span>
                    </button>
                    <div class="h-px bg-slate-200 dark:bg-slate-700 my-1"></div>
                    <button onclick="resetApp()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 flex items-center justify-between transition-colors">
                        <span class="text-sm font-medium"><i class="fa-solid fa-trash-can mr-3"></i>データクリア</span>
                    </button>
                </div>
            </div>
            
            <!-- Overlay for closing menu -->
            <div id="menuOverlay" onclick="closeMenu()" class="fixed inset-0 z-40 hidden"></div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="pt-24 pb-32 px-4 max-w-md mx-auto min-h-screen relative">

        <!-- HERO SECTION -->
        <section id="hero" class="flex flex-col items-center text-center animate-fade-in">
            <div class="mb-6 mt-10 relative">
                <div class="absolute inset-0 bg-brand/20 blur-xl rounded-full animate-pulse"></div>
                <i class="fa-solid fa-lightbulb text-6xl text-brand dark:text-brand-light relative z-10 animate-float"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 leading-tight">
                循環アイディア<br>
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-brand to-brand-light">発掘ナビ</span>
            </h1>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6 font-medium tracking-wide">捨てているものを、価値に変える。</p>
            
            <p class="text-slate-600 dark:text-slate-300 mb-10 text-sm leading-relaxed max-w-xs mx-auto">
                あなたのビジネスの「ムダ・コスト・手間」を<br>
                別業界のニーズにつなげて<br>
                「売れる形」に整えます。
            </p>

            <div class="flex flex-col gap-4 w-full max-w-xs">
                <button onclick="startApp()" class="w-full bg-gradient-to-r from-brand to-brand-light text-white font-bold py-4 rounded-2xl shadow-lg shadow-brand/30 hover:shadow-brand/50 transform hover:-translate-y-1 active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                    <span>診断をはじめる</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <button onclick="showCaseStudy()" class="w-full bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-medium py-3 rounded-2xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transform active:scale-95 transition-all duration-200 text-sm">
                    <i class="fa-solid fa-book-open mr-2"></i> 事例を見る
                </button>
            </div>
        </section>

        <!-- WIZARD SECTION -->
        <section id="wizard" class="hidden">
            <!-- Progress Bar -->
            <div class="mb-8 sticky top-20 z-30 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm py-2 -mx-4 px-4 border-b border-slate-200/50 dark:border-slate-700/50">
                <div class="flex justify-between items-end mb-2">
                    <span id="stepLabel" class="text-xs font-bold text-brand dark:text-brand-light uppercase tracking-wider">STEP 1</span>
                    <span id="stepCounter" class="text-xs text-slate-400">1 / 5</span>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-brand to-brand-light h-full rounded-full transition-all duration-500 ease-out" style="width: 20%"></div>
                </div>
            </div>

            <!-- Steps Container -->
            <div id="stepsContainer" class="relative min-h-[400px]">
                
                <!-- STEP 1: Problems -->
                <div id="step1" class="step-transition active-step w-full">
                    <h2 class="text-xl font-bold mb-6">今、困っていることは？<br><span class="text-sm font-normal text-slate-500 dark:text-slate-400">ビジネスの「負」を選択してください</span></h2>
                    <div class="space-y-3 mb-6">
                        <label class="block relative cursor-pointer group">
                            <input type="checkbox" name="problems" value="電気代が高い" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex items-center gap-3 group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center"><i class="fa-solid fa-bolt"></i></div>
                                <span class="text-sm font-medium">電気代・燃料費が高い</span>
                            </div>
                        </label>
                        <label class="block relative cursor-pointer group">
                            <input type="checkbox" name="problems" value="人手不足" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex items-center gap-3 group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-user-xmark"></i></div>
                                <span class="text-sm font-medium">人手不足・採用難</span>
                            </div>
                        </label>
                        <label class="block relative cursor-pointer group">
                            <input type="checkbox" name="problems" value="在庫ロス" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex items-center gap-3 group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <div class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-500 flex items-center justify-center"><i class="fa-solid fa-boxes-stacked"></i></div>
                                <span class="text-sm font-medium">在庫ロス・廃棄コスト</span>
                            </div>
                        </label>
                        <label class="block relative cursor-pointer group">
                            <input type="checkbox" name="problems" value="温度管理" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex items-center gap-3 group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-500 flex items-center justify-center"><i class="fa-solid fa-temperature-arrow-up"></i></div>
                                <span class="text-sm font-medium">暑い・寒い・温度管理</span>
                            </div>
                        </label>
                        <label class="block relative cursor-pointer group">
                            <input type="checkbox" name="problems" value="場所がない" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex items-center gap-3 group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-500 flex items-center justify-center"><i class="fa-solid fa-maximize"></i></div>
                                <span class="text-sm font-medium">場所がない・狭い</span>
                            </div>
                        </label>
                    </div>
                    <div class="glass-card p-4 rounded-xl">
                        <label class="block text-xs text-slate-500 dark:text-slate-400 mb-2">その他（具体的に）</label>
                        <textarea id="problem_free" class="w-full bg-transparent border-b border-slate-300 dark:border-slate-600 focus:border-brand focus:outline-none py-2 text-sm h-16 resize-none transition-colors" placeholder="例：夜間の設備稼働率が低い..."></textarea>
                    </div>
                </div>

                <!-- STEP 2: Resource/Cause -->
                <div id="step2" class="step-transition hidden-step w-full">
                    <h2 class="text-xl font-bold mb-6">それは何が原因？<br><span class="text-sm font-normal text-slate-500 dark:text-slate-400">裏を返せば、それが「資源」です</span></h2>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="resource" value="熱エネルギー" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex flex-col items-center justify-center h-32 text-center group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <i class="fa-solid fa-fire text-2xl mb-2 text-red-500"></i>
                                <span class="text-sm font-medium">熱・排熱</span>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="resource" value="冷熱エネルギー" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex flex-col items-center justify-center h-32 text-center group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <i class="fa-solid fa-snowflake text-2xl mb-2 text-blue-500"></i>
                                <span class="text-sm font-medium">冷気・雪・氷</span>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="resource" value="データ・知識" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex flex-col items-center justify-center h-32 text-center group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <i class="fa-solid fa-database text-2xl mb-2 text-emerald-500"></i>
                                <span class="text-sm font-medium">データ・ログ</span>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="resource" value="空間・場所" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex flex-col items-center justify-center h-32 text-center group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <i class="fa-solid fa-warehouse text-2xl mb-2 text-orange-500"></i>
                                <span class="text-sm font-medium">空きスペース</span>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="resource" value="副産物・素材" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex flex-col items-center justify-center h-32 text-center group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <i class="fa-solid fa-recycle text-2xl mb-2 text-green-500"></i>
                                <span class="text-sm font-medium">廃材・副産物</span>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="resource" value="専門スキル" class="input-hidden">
                            <div class="selection-card glass-card p-4 rounded-xl flex flex-col items-center justify-center h-32 text-center group-hover:bg-white/60 dark:group-hover:bg-slate-700/60">
                                <i class="fa-solid fa-hands-holding-circle text-2xl mb-2 text-purple-500"></i>
                                <span class="text-sm font-medium">特殊スキル</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- STEP 3: Needs (Inversion) -->
                <div id="step3" class="step-transition hidden-step w-full">
                    <h2 class="text-xl font-bold mb-6">それは誰のニーズになる？<br><span class="text-sm font-normal text-slate-500 dark:text-slate-400">視点を180度反転させます</span></h2>
                    <div class="glass-card p-6 rounded-2xl mb-6">
                        <p class="text-sm font-bold mb-4 text-brand dark:text-brand-light">この資源で何ができる？</p>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 cursor-pointer transition-colors">
                                <input type="checkbox" name="needs" value="温めたい・乾燥させたい" class="w-5 h-5 text-brand rounded focus:ring-brand border-gray-300">
                                <span class="text-sm">温めたい・乾燥させたい</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 cursor-pointer transition-colors">
                                <input type="checkbox" name="needs" value="冷やしたい・保存したい" class="w-5 h-5 text-brand rounded focus:ring-brand border-gray-300">
                                <span class="text-sm">冷やしたい・保存したい</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 cursor-pointer transition-colors">
                                <input type="checkbox" name="needs" value="予測したい・効率化したい" class="w-5 h-5 text-brand rounded focus:ring-brand border-gray-300">
                                <span class="text-sm">予測したい・効率化したい</span>
                            </label>
                             <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 cursor-pointer transition-colors">
                                <input type="checkbox" name="needs" value="体験したい・学びたい" class="w-5 h-5 text-brand rounded focus:ring-brand border-gray-300">
                                <span class="text-sm">体験したい・学びたい</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="glass-card p-6 rounded-2xl">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs font-bold text-slate-500">優先度</span>
                            <span class="text-xs font-bold text-brand" id="priorityValue">重要</span>
                        </div>
                        <input type="range" id="priority" min="1" max="3" value="2" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between mt-2 text-[10px] text-slate-400">
                            <span>おまけ</span>
                            <span>普通</span>
                            <span>最重要</span>
                        </div>
                    </div>
                </div>

                <!-- STEP 4: Industry & Location -->
                <div id="step4" class="step-transition hidden-step w-full">
                    <h2 class="text-xl font-bold mb-6">業界をまたぐ<br><span class="text-sm font-normal text-slate-500 dark:text-slate-400">遠い業界ほどイノベーションになります</span></h2>
                    
                    <div class="mb-6">
                        <p class="text-xs font-bold text-slate-500 mb-3 ml-1">ターゲット業界（複数可）</p>
                        <div class="flex flex-wrap gap-2">
                            <!-- Helper to generate chips -->
                            <script>
                                const industries = ['農業', '漁業', '飲食', '製造', '建設', '医療', '介護', '教育', '物流', 'IT', '観光', '行政'];
                                industries.forEach(ind => {
                                    document.write(`
                                        <label class="cursor-pointer">
                                            <input type="checkbox" name="target_industry" value="${ind}" class="input-hidden peer">
                                            <span class="inline-block px-4 py-2 rounded-full text-xs font-medium bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 peer-checked:bg-brand peer-checked:text-white peer-checked:border-brand transition-all active:scale-95 shadow-sm">${ind}</span>
                                        </label>
                                    `);
                                });
                            </script>
                        </div>
                    </div>

                    <div class="glass-card p-4 rounded-xl">
                        <label class="block text-xs text-slate-500 dark:text-slate-400 mb-2">地域特性があればチェック</label>
                        <select id="location_feature" class="w-full bg-transparent text-sm border-b border-slate-300 dark:border-slate-600 py-2 focus:outline-none focus:border-brand">
                            <option value="">特になし</option>
                            <option value="寒冷地・豪雪">寒冷地・豪雪</option>
                            <option value="猛暑・南国">猛暑・南国</option>
                            <option value="観光地">観光地</option>
                            <option value="過疎・人口減">過疎・人口減</option>
                            <option value="都市部・密集">都市部・密集</option>
                        </select>
                    </div>
                </div>

                <!-- STEP 5: Productize -->
                <div id="step5" class="step-transition hidden-step w-full">
                    <h2 class="text-xl font-bold mb-6">売り物にすると？<br><span class="text-sm font-normal text-slate-500 dark:text-slate-400">商品化の輪郭を作ります</span></h2>
                    
                    <div class="space-y-4">
                        <div class="glass-card p-4 rounded-xl">
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">提供形態</label>
                            <select id="product_type" class="w-full bg-transparent text-sm border-b border-slate-300 dark:border-slate-600 py-2 focus:outline-none focus:border-brand">
                                <option value="サービス提供">代行サービス</option>
                                <option value="サブスクリプション">月額会員制（サブスク）</option>
                                <option value="設備販売・工事">設備販売・工事</option>
                                <option value="コンサル・診断">コンサル・診断</option>
                                <option value="データ販売">データ・情報販売</option>
                                <option value="空間レンタル">場所貸し</option>
                            </select>
                        </div>

                        <div class="glass-card p-4 rounded-xl">
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">価格イメージ</label>
                            <div class="flex items-center gap-4">
                                <input type="range" id="price_range" min="1" max="5" value="3" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div class="flex justify-between mt-2 text-[10px] text-slate-400">
                                <span>無料/集客</span>
                                <span>低単価</span>
                                <span>高付加価値</span>
                            </div>
                        </div>

                        <div class="glass-card p-4 rounded-xl">
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">誰に売る？（一言で）</label>
                            <input type="text" id="target_persona" class="w-full bg-transparent border-b border-slate-300 dark:border-slate-600 focus:border-brand focus:outline-none py-2 text-sm transition-colors" placeholder="例：コスト削減したい施設長">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Wizard Footer Navigation -->
            <div class="fixed bottom-0 left-0 w-full glass border-t border-white/20 p-4 z-40 no-print">
                <div class="max-w-md mx-auto flex justify-between gap-4">
                    <button id="prevBtn" onclick="changeStep(-1)" class="px-6 py-3 rounded-xl font-medium text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors hidden">戻る</button>
                    
                    <div class="flex-1 flex items-center justify-center text-xs text-slate-400 gap-2">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <span id="saveStatus">自動保存中</span>
                    </div>

                    <button id="nextBtn" onclick="changeStep(1)" class="px-8 py-3 bg-slate-800 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold shadow-lg hover:shadow-xl transform active:scale-95 transition-all">次へ</button>
                    <button id="finishBtn" onclick="generateResult()" class="px-8 py-3 bg-gradient-to-r from-brand to-brand-light text-white rounded-xl font-bold shadow-lg shadow-brand/30 transform active:scale-95 transition-all hidden">診断完了</button>
                </div>
            </div>
        </section>

        <!-- RESULT SECTION -->
        <section id="result" class="hidden animate-slide-up pb-20">
            <div class="no-print mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold">診断結果</h2>
                <div class="flex gap-2">
                    <!-- 印刷ボタン削除 -->
                    <button onclick="resetApp()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 shadow flex items-center justify-center hover:text-red-500 transition-colors"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
            </div>

            <!-- Result Cards -->
            <div id="resultContent" class="space-y-6">
                <!-- A. Core Idea -->
                <div class="glass-card p-6 rounded-2xl border-t-4 border-brand relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-bullseye text-6xl"></i>
                    </div>
                    <h3 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3">CORE CONCEPT</h3>
                    <p id="res_core" class="text-xl font-bold leading-relaxed text-slate-800 dark:text-white">
                        <!-- JS Generated -->
                    </p>
                </div>

                <!-- B. 3 Proposals -->
                <div>
                    <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-4 px-2">3つの具体案</h3>
                    <div class="space-y-4">
                        <div class="glass-card p-5 rounded-xl hover:translate-x-1 transition-transform cursor-default">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 text-[10px] font-bold px-2 py-1 rounded">SPEED</span>
                                <h4 class="font-bold text-sm">最短で試すなら</h4>
                            </div>
                            <p id="res_plan1" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed"></p>
                        </div>
                        <div class="glass-card p-5 rounded-xl hover:translate-x-1 transition-transform cursor-default">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-300 text-[10px] font-bold px-2 py-1 rounded">PROFIT</span>
                                <h4 class="font-bold text-sm">利益率重視なら</h4>
                            </div>
                            <p id="res_plan2" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed"></p>
                        </div>
                        <div class="glass-card p-5 rounded-xl hover:translate-x-1 transition-transform cursor-default">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 text-[10px] font-bold px-2 py-1 rounded">VIRAL</span>
                                <h4 class="font-bold text-sm">話題性・SDGs文脈なら</h4>
                            </div>
                            <p id="res_plan3" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed"></p>
                        </div>
                    </div>
                </div>

                <!-- C. Next Steps -->
                <div class="glass-card p-6 rounded-2xl bg-slate-50/50 dark:bg-slate-800/50">
                    <h3 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4">NEXT ACTION</h3>
                    <ul class="space-y-4 text-sm">
                        <li class="flex gap-3">
                            <div class="mt-1 w-5 h-5 rounded-full bg-brand text-white flex items-center justify-center text-xs flex-shrink-0">1</div>
                            <div>
                                <span class="font-bold block text-slate-700 dark:text-slate-200">まず会うべき人</span>
                                <span id="res_who" class="text-slate-500 dark:text-slate-400"></span>
                            </div>
                        </li>
                        <li class="flex gap-3">
                            <div class="mt-1 w-5 h-5 rounded-full bg-brand text-white flex items-center justify-center text-xs flex-shrink-0">2</div>
                            <div>
                                <span class="font-bold block text-slate-700 dark:text-slate-200">商談の一言トーク</span>
                                <div id="res_talk" class="mt-2 p-3 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 italic text-slate-600 dark:text-slate-300"></div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex flex-col gap-4 no-print">
                <button onclick="copyResult()" class="w-full bg-white dark:bg-slate-800 text-brand font-bold py-4 rounded-xl border-2 border-brand hover:bg-brand/5 transition-colors shadow-md active:scale-95 transform duration-200">
                    <i class="fa-regular fa-copy mr-2"></i>魔法プロンプト付きでコピー
                </button>
                <!-- 印刷ボタン削除 -->
                <button onclick="startApp()" class="w-full text-slate-400 text-sm py-2 hover:text-slate-600 transition-colors">
                    内容を修正して再診断
                </button>
            </div>

            <!-- Footer CTA -->
            <div class="mt-12 glass-card p-6 rounded-2xl text-center relative overflow-hidden no-print">
                <div class="absolute inset-0 bg-gradient-to-br from-brand/10 to-transparent"></div>
                <h3 class="font-bold text-lg mb-2 relative z-10">このアイディア、形にしませんか？</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6 relative z-10">ヒヤリングから提案資料化、LP制作、アプリ開発まで伴走可能です。</p>
                <a href="https://www.smileplusctg.com/contact" target="_blank" rel="noopener noreferrer" class="inline-block w-full bg-brand text-white font-bold py-3 rounded-xl shadow-lg relative z-10 hover:bg-brand-dark transition-colors">
                    開発者に相談する
                </a>
                <p class="text-[10px] text-slate-400 mt-4 relative z-10">※現在はβ版テスト中です</p>
            </div>
        </section>

    </main>

    <!-- Modal for Case Study -->
    <div id="caseModal" class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-300" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-4">
            <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-95 opacity-0" id="modalContent">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">循環アイディア事例</h3>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    
                    <div class="relative pl-4 border-l-2 border-slate-200 dark:border-slate-700 space-y-6">
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-blue-400"></div>
                            <p class="text-xs text-slate-400 mb-1">RESOURCE</p>
                            <p class="font-bold">北海道の「雪」と「冷気」</p>
                            <p class="text-xs text-slate-500">これまでは除雪コストがかかる厄介者</p>
                        </div>
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-purple-400"></div>
                            <p class="text-xs text-slate-400 mb-1">NEEDS (IT業界)</p>
                            <p class="font-bold">AIサーバーの冷却</p>
                            <p class="text-xs text-slate-500">膨大な電気代がかかる冷却を雪冷房で解決</p>
                        </div>
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-red-400"></div>
                            <p class="text-xs text-slate-400 mb-1">RESOURCE (NEW)</p>
                            <p class="font-bold">サーバーからの「温排熱」</p>
                            <p class="text-xs text-slate-500">今度は熱が余るようになる</p>
                        </div>
                         <div class="relative">
                            <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-orange-400"></div>
                            <p class="text-xs text-slate-400 mb-1">PRODUCT (漁業)</p>
                            <p class="font-bold">ウナギの養殖</p>
                            <p class="text-xs text-slate-500">温水が必要な養殖に転用し、ブランド化</p>
                        </div>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full mt-6 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-bold text-sm">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Guide (New) -->
    <div id="guideModal" class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-300" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeGuideModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-4">
            <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-95 opacity-0" id="guideContent">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg"><i class="fa-solid fa-circle-question text-brand mr-2"></i>このアプリの使い方</h3>
                        <button onclick="closeGuideModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-sm mb-2 text-slate-800 dark:text-slate-200">目的</h4>
                            <p class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">
                                自社の「困りごと（負）」を視点を変えて「資源」と捉え直し、異業種のニーズと結びつけることで新しいビジネスアイディアを生み出します。
                            </p>
                        </div>

                        <div>
                             <h4 class="font-bold text-sm mb-3 text-slate-800 dark:text-slate-200">使い方の流れ</h4>
                             <div class="space-y-3 relative">
                                 <!-- Vertical Line -->
                                 <div class="absolute left-3 top-2 bottom-2 w-0.5 bg-slate-200 dark:bg-slate-700"></div>
                                 
                                 <div class="flex gap-3 relative z-10">
                                     <div class="w-6 h-6 rounded-full bg-brand text-white text-[10px] font-bold flex items-center justify-center shrink-0">1</div>
                                     <div>
                                         <p class="text-xs font-bold">困りごとの選択</p>
                                         <p class="text-[10px] text-slate-400">コストや手間の原因を選びます</p>
                                     </div>
                                 </div>
                                 <div class="flex gap-3 relative z-10">
                                     <div class="w-6 h-6 rounded-full bg-brand text-white text-[10px] font-bold flex items-center justify-center shrink-0">2</div>
                                     <div>
                                         <p class="text-xs font-bold">資源への反転</p>
                                         <p class="text-[10px] text-slate-400">困りごとを「エネルギー」等に読み替えます</p>
                                     </div>
                                 </div>
                                 <div class="flex gap-3 relative z-10">
                                     <div class="w-6 h-6 rounded-full bg-brand text-white text-[10px] font-bold flex items-center justify-center shrink-0">3</div>
                                     <div>
                                         <p class="text-xs font-bold">ニーズと業界のマッチング</p>
                                         <p class="text-[10px] text-slate-400">その資源を欲しがる異業種を探します</p>
                                     </div>
                                 </div>
                                 <div class="flex gap-3 relative z-10">
                                     <div class="w-6 h-6 rounded-full bg-brand text-white text-[10px] font-bold flex items-center justify-center shrink-0">4</div>
                                     <div>
                                         <p class="text-xs font-bold">アイディア生成</p>
                                         <p class="text-[10px] text-slate-400">具体案と次のアクションが提案されます</p>
                                     </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                    
                    <button onclick="closeGuideModal()" class="w-full mt-6 bg-brand text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-brand/30">はじめる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-bold opacity-0 pointer-events-none transition-opacity duration-300 z-50">
        <i class="fa-solid fa-check mr-2 text-green-400"></i><span id="toastMsg">Saved</span>
    </div>

    <script>
        // --- State Management ---
        const totalSteps = 5;
        let currentStep = 1;
        let formData = {
            problems: [],
            problem_free: '',
            resource: '',
            needs: [],
            priority: '2',
            target_industry: [],
            location: '',
            product_type: '',
            price_range: '3',
            target_persona: ''
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initTheme();
            setupListeners();
            updateUI();
        });

        function setupListeners() {
            // Priority Slider Label
            document.getElementById('priority').addEventListener('input', (e) => {
                const labels = ['おまけ', '普通', '最重要'];
                document.getElementById('priorityValue').textContent = labels[e.target.value - 1];
                saveData();
            });

            // Save on any input change
            document.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('change', saveData);
                el.addEventListener('input', saveData); // For smoother typing save
            });
        }

        // --- Navigation Logic ---
        function startApp() {
            document.getElementById('hero').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('wizard').classList.remove('hidden');
            currentStep = 1;
            updateStepVisibility();
            window.scrollTo(0,0);
        }

        function goToHero() {
            document.getElementById('wizard').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('hero').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function changeStep(dir) {
            const next = currentStep + dir;
            if (next < 1 || next > totalSteps) return;
            
            // Validation (Optional but good for UX)
            if (dir > 0 && next === 2 && formData.problems.length === 0 && !formData.problem_free) {
                showToast('困っていることを選択してください');
                return;
            }

            currentStep = next;
            updateStepVisibility();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStepVisibility() {
            // Update Progress
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('stepCounter').textContent = `${currentStep} / ${totalSteps}`;
            document.getElementById('stepLabel').textContent = `STEP ${currentStep}`;

            // Show/Hide Steps
            for (let i = 1; i <= totalSteps; i++) {
                const el = document.getElementById(`step${i}`);
                if (i === currentStep) {
                    el.classList.remove('hidden-step');
                    el.classList.add('active-step');
                    // Small timeout to allow display:block to apply before opacity transition
                    setTimeout(() => el.style.opacity = 1, 10);
                } else {
                    el.classList.remove('active-step');
                    el.classList.add('hidden-step');
                    el.style.opacity = 0;
                }
            }

            // Buttons
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            if (currentStep === totalSteps) {
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('finishBtn').classList.remove('hidden');
            } else {
                document.getElementById('nextBtn').classList.remove('hidden');
                document.getElementById('finishBtn').classList.add('hidden');
            }
        }

        // --- Data Handling ---
        function saveData() {
            // Collect Data
            formData.problems = Array.from(document.querySelectorAll('input[name="problems"]:checked')).map(cb => cb.value);
            formData.problem_free = document.getElementById('problem_free').value;
            
            const resRadio = document.querySelector('input[name="resource"]:checked');
            formData.resource = resRadio ? resRadio.value : '';
            
            formData.needs = Array.from(document.querySelectorAll('input[name="needs"]:checked')).map(cb => cb.value);
            formData.priority = document.getElementById('priority').value;
            
            formData.target_industry = Array.from(document.querySelectorAll('input[name="target_industry"]:checked')).map(cb => cb.value);
            formData.location = document.getElementById('location_feature').value;
            
            formData.product_type = document.getElementById('product_type').value;
            formData.price_range = document.getElementById('price_range').value;
            formData.target_persona = document.getElementById('target_persona').value;

            localStorage.setItem('ideaApp_data', JSON.stringify(formData));
            
            // Visual feedback
            const status = document.getElementById('saveStatus');
            status.textContent = '保存済み';
            setTimeout(() => status.textContent = '自動保存中', 2000);
        }

        function loadData() {
            const saved = localStorage.getItem('ideaApp_data');
            if (saved) {
                formData = JSON.parse(saved);
                applyFormData();
            }
        }

        function applyFormData() {
            // Clear current selection first
            document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(el => el.checked = false);
            
            // Restore UI
            formData.problems.forEach(v => check(`input[name="problems"][value="${v}"]`));
            if(formData.problem_free) document.getElementById('problem_free').value = formData.problem_free;
            else document.getElementById('problem_free').value = '';
            
            if(formData.resource) check(`input[name="resource"][value="${formData.resource}"]`);
            
            formData.needs.forEach(v => check(`input[name="needs"][value="${v}"]`));
            document.getElementById('priority').value = formData.priority || 2;
            
            formData.target_industry.forEach(v => check(`input[name="target_industry"][value="${v}"]`));
            if(formData.location) document.getElementById('location_feature').value = formData.location;
            else document.getElementById('location_feature').value = '';
            
            if(formData.product_type) document.getElementById('product_type').value = formData.product_type;
            document.getElementById('price_range').value = formData.price_range || 3;
            if(formData.target_persona) document.getElementById('target_persona').value = formData.target_persona;
            else document.getElementById('target_persona').value = '';
            
            updateUI();
        }
        
        function updateUI() {
            // Update dynamic labels that depend on input values
            const labels = ['おまけ', '普通', '最重要'];
            const priorityInput = document.getElementById('priority');
            const priorityLabel = document.getElementById('priorityValue');
            
            if (priorityInput && priorityLabel) {
                priorityLabel.textContent = labels[priorityInput.value - 1] || '普通';
            }
        }
        
        function check(selector) {
            const el = document.querySelector(selector);
            if (el) el.checked = true;
        }

        function resetApp() {
            if(confirm('入力内容をすべて消去しますか？')) {
                localStorage.removeItem('ideaApp_data');
                location.reload();
            }
            closeMenu();
        }

        function fillDemoData() {
            formData = {
                problems: ['在庫ロス', '場所がない'],
                problem_free: '',
                resource: '空間・場所',
                needs: ['冷やしたい・保存したい'],
                priority: '3',
                target_industry: ['物流', '飲食'],
                location: '都市部・密集',
                product_type: '空間レンタル',
                price_range: '2',
                target_persona: '駅近で倉庫を探しているEC事業者'
            };
            
            applyFormData();
            saveData();
            showToast('デモデータを入力しました');
            closeMenu();
            startApp();
        }

        // --- Logic: Generate Result ---
        function generateResult() {
            saveData(); // Ensure latest data

            // Defaults if empty
            const r_res = formData.resource || "未利用資源";
            const r_ind = formData.target_industry.length > 0 ? formData.target_industry.join("・") : "別業界";
            const r_need = formData.needs.length > 0 ? formData.needs[0].split("・")[0] : "課題解決";
            const r_prod = formData.product_type || "サービス";
            const r_who = formData.target_persona || "ターゲット顧客";

            // A. Core Idea
            const coreText = `「${r_res}」を、${r_ind}業界の「${r_need}」ニーズに変えて、${r_prod}として提供する。`;
            document.getElementById('res_core').textContent = coreText;

            // B. Proposals (Mad Libs Style logic)
            // Plan 1: Speed
            document.getElementById('res_plan1').textContent = 
                `${r_ind}業界の小規模事業者向けに、${r_res}を${formData.price_range < 3 ? '無料または安価で' : 'テスト版として'}提供し、実績を作る${r_prod}モデル。`;

            // Plan 2: Profit
            document.getElementById('res_plan2').textContent = 
                `${r_who}が最もコストをかけている部分を、${r_res}で代替する${formData.price_range > 3 ? '高付加価値' : '定期契約（サブスク）'}プラン。`;

            // Plan 3: Viral/New
            const locText = formData.location ? `（${formData.location}）` : "";
            document.getElementById('res_plan3').textContent = 
                `「${r_res} × ${r_ind} ${locText}」という異色の組み合わせをPRし、SDGsや地域循環モデルとしてブランディングする。`;

            // C. Next Actions
            document.getElementById('res_who').textContent = `${r_ind}業界の現場責任者、または${r_who}。`;
            
            document.getElementById('res_talk').textContent = 
                `「御社のコスト削減（または${r_need}）について、弊社の余剰リソース（${r_res}）を活用して、相場の半額以下で解決できる提案があるのですが、一度シミュレーションだけでも見ませんか？」`;

            // Transition
            document.getElementById('wizard').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // --- Utils ---
        function copyResult() {
            const core = document.getElementById('res_core').textContent;
            const p1 = document.getElementById('res_plan1').textContent;
            const p2 = document.getElementById('res_plan2').textContent;
            const p3 = document.getElementById('res_plan3').textContent;
            const who = document.getElementById('res_who').textContent;
            
            const text = `【循環アイディア診断結果】

■アイディアの核
${core}

■具体案
1. スピード重視案: ${p1}
2. 収益重視案: ${p2}
3. 話題性重視案: ${p3}

■ターゲット
${who}

--------------------------------------------------
▼ アイディアを形にする魔法のプロンプト
（この下をコピーしてNotebookLMなどに貼り付けると、スライド構成や図解案を出力できます）

あなたは優秀なビジネスデザイナーです。以下の「循環型ビジネスアイディア」をもとに、この事業の魅力を伝えるための資料構成とインフォグラフィック案を作成してください。

【入力情報】
・コンセプト: ${core}
・ターゲット: ${who}
・展開案: 
  - ${p1}
  - ${p2}
  - ${p3}

【出力してほしいもの】
1. 投資家向けピッチ資料の構成案（全5枚：課題、解決策、ビジネスモデル、市場性、将来性）
2. コンセプトを一枚絵で説明するためのインフォグラフィックのラフ案（中央に何を置き、どう循環しているか言葉で説明）
3. このビジネスが解決する「社会的意義」と「経済的合理性」の言語化
--------------------------------------------------`;
            
            // Fallback for iframe restrictions where navigator.clipboard might be blocked
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";  // Avoid scrolling to bottom
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('魔法プロンプト付きでコピーしました');
                } else {
                    showToast('コピーに失敗しました');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showToast('コピーエラーが発生しました');
            }

            document.body.removeChild(textArea);
        }

        function showToast(msg) {
            const el = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            el.style.opacity = '1';
            el.style.transform = 'translate(-50%, -10px)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translate(-50%, 0)';
            }, 3000);
        }

        // --- Menu & Modals ---
        function toggleMenu() {
            const menu = document.getElementById('settingsMenu');
            const overlay = document.getElementById('menuOverlay');
            if (menu.classList.contains('active')) {
                closeMenu();
            } else {
                menu.classList.add('active');
                overlay.classList.remove('hidden');
            }
        }

        function closeMenu() {
            document.getElementById('settingsMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.add('hidden');
        }

        function showCaseStudy() {
            showModal('caseModal');
        }

        function closeModal() {
            hideModal('caseModal');
        }

        function showGuideModal() {
            showModal('guideModal', 'guideContent');
        }

        function closeGuideModal() {
            hideModal('guideModal', 'guideContent');
        }

        function showModal(modalId, contentId = 'modalContent') {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            modal.classList.remove('hidden');
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 50);
        }

        function hideModal(modalId, contentId = 'modalContent') {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- Theme ---
        function initTheme() {
            const btn = document.getElementById('themeToggle');
            // Check stored or system preference
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            btn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.theme = 'dark';
                } else {
                    localStorage.theme = 'light';
                }
                closeMenu();
            });
        }
    </script>
</body>
</html>